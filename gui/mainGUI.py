import sys
sys.path.insert(1, '../')
from ADD_SYS_PATHS import addSysPaths
addSysPaths()
import customtkinter as ct
from tkinter import filedialog
from pathlib import Path

def GUI():
    yara_rules = Path("../yara_rules").glob('*')
    from signature_based import fullSystemScan #multi-threaded
    from signature_based import fileScan
    from signature_based import folderScan
    from signature_based import exitProgram
    from signature_based import add_to_whitelist
    from behavior_based import getPIDs #multi-threaded
    from behavior_based import YARA_PIDScan
    
    #|--------------------Signature Based/Main GUI--------------------|
    ct.set_appearance_mode("dark")
    ct.set_default_color_theme("green")
    root = ct.CTk()
    root.geometry("1366x768")
    root.title("Anti-Malware Program")
    frame = ct.CTkFrame(master=root)
    frame.pack(pady=20, padx=60, fill="both", expand=True)

    labelOne = ct.CTkLabel(master=frame, text="Get started by scanning specific files, a folder, or the entire system.")
    labelTwo = ct.CTkLabel(master=frame, text="WARNING: Files that require admin rights or are in use by the system might not be scanned!")
    labelOne.pack(pady=12, padx=10)
    labelTwo.pack(pady=12, padx=10)
    
    entry = ct.CTkEntry(master=frame, placeholder_text="File path to scan:")
    entry.pack(pady=12, padx=10)

    def fileScanPath(event=None):
        file_path = entry.get()
        if os.path.exists(file_path):
            fileScan(file_path)
        else:
            print("Invalid file path. Please enter a valid path.")

    def fileScanAction():
        file_path = filedialog.askopenfilename()  #File Scan action
        if file_path:
            fileScan(file_path)
    def folderScanAction():
        folder_path = filedialog.askdirectory()  #Folder Scan action
        if folder_path:
            folderScan(folder_path)
        
    def fullSystemScanAction():                  #Full System Scan action
        fullSystemScan()
    
    def addToWhitelistAction():
        file_path = filedialog.askopenfilename()
        if file_path:
            add_to_whitelist(file_path)
    
    def processID_Action():
        print("Checking against Yara database...")
        matches = YARA_PIDScan(yara_rules)
        if matches:
            print("Match found!")
            for match in matches:
                print(match)
        else:
            print("No matches found.")
        #getPIDs()
        
    def yaraScanAction():
        print("Checking against Yara database...")
        matches = YARA_fileScan(yara_rules)
        if matches:
            print("Match found!")
            for match in matches:
                print(match)
        else:
            print("No matches found.")
        
        
    entry.bind("<Return>", fileScanPath)
    
    
    #File Scan Button
    fileScanButton = ct.CTkButton(master=frame, text="File Scan", command=fileScanAction)
    fileScanButton.pack(pady=12, padx=10)
    
    #folder scan button
    folderScanButton = ct.CTkButton(master=frame, text="Folder Scan", command=folderScanAction)
    folderScanButton.pack(pady=12, padx=10)
    
    #system scan button
    systemScanButton = ct.CTkButton(master=frame, text="Full System Scan", command=fullSystemScan)
    runningLabel = ct.CTkLabel(master=frame, text="scanning all files...")
    systemScanButton.pack(pady=12, padx=10)
    
    #Whitelist button
    addToWhitelistButton = ct.CTkButton(master=frame, text="Add to Whitelist", command=addToWhitelistAction)
    addToWhitelistButton.pack(pady=12, padx=10)

    #get process ID button
    processIDbutton = ct.CTkButton(master=frame, text="Get all Process IDs", command=processID_Action)
    processIDbutton.pack(pady=12, padx=10)

    #YARA_fileScan
    yaraScan = ct.CTkButton(master=frame, text="Scan System using Yara rules", command=processID_Action)
    yaraScan.pack(pady=12, padx=10)

    #exit button
    exitButton = ct.CTkButton(master=frame, text="Exit", command=exitProgram)
    exitButton.pack(pady=12, padx=10)

    root.mainloop()
    #|--------------------------------------------------|
    
    
