import os
import winreg
import subprocess
from easygui import ynbox

# 3/15 update - set to true since program comes with uninstaller now
startupHook_enabled = True

def startupHook():
    path = f"C:/Users/{os.getlogin()}/AppData/Roaming/Microsoft/Windows/Start Menu/Programs/Startup"
    connection = winreg.ConnectRegistry(None, winreg.HKEY_CURRENT_USER)
    key = winreg.OpenKey(connection, r'SOFTWARE\Bonfire Security')
    cwd = os.getcwd() + chr(92) # chr(92) == '\'
    install_path = winreg.EnumValue(key, 1)[1]
    shortcut_name = "Bonfire Security BG Scans"
    if not os.path.isfile(path + f"/{shortcut_name}.lnk") or os.getcwd() != install_path:
        if not os.path.isdir("__tmp"):
            os.mkdir("__tmp")

        # Creates a VB Script that creates a shortcut to bg_actions.py and places it in Startup
        shortcut_script = [f'Set script = WScript.CreateObject("WScript.Shell")',
                           f'link_file = "{path}/{shortcut_name}.lnk"',
                           f'Set link = script.CreateShortcut(link_file)',
                           f'link.TargetPath = "{cwd}background\\bg_actions.py"',
                           f'link.Save']
        
        with open("__tmp/tmp.vbs", "w") as tmp:
            for line in shortcut_script:
                tmp.write(line)
                tmp.write("\n")
        tmp.close()

        if not os.path.isfile(path + f"/{shortcut_name}.lnk"):
            choice = ynbox("Run scheduled background scans on startup?")
            if choice:
                subprocess.call("cscript __tmp/tmp.vbs")
        os.remove("__tmp/tmp.vbs")

if startupHook_enabled:
    startupHook()
    
    
    
