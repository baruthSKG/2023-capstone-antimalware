import sys
sys.path.insert(1, '../')
from ADD_SYS_PATHS import addSysPaths
addSysPaths()
import os
import shutil
import psutil
import traceback
from datetime import datetime
import pyuac # Requires pypiwin32
import json

# Moves file, archives it, then removes original file
def quarantine(filepath):
    # Make folder to place files to archive
    archiveFolder = "toArchive"
    
    count = 1
    origFolder = archiveFolder
    while os.path.isdir(archiveFolder):
        archiveFolder = f"{origFolder} ({count})"
        count += 1
    
    os.mkdir(archiveFolder)
        
    # Make file name for archive
    storageFolder = "archivedFiles"
    try:
        os.mkdir(storageFolder) # Make folder if doesn't exist
    except:
        pass
    filename = storageFolder + "\\" + datetime.now().strftime("%m-%d-%Y %H-%M-%S")
    
    count = 1
    origFilename = filename
    while os.path.isfile(filename) or os.path.isfile(filename + ".zip"):
        filename = f"{origFilename} ({count})"
        count += 1
    
    # Move file
    attempts = 0
    max = 3
    while attempts < max:
        if os.path.isdir(filepath) or os.path.isfile(filepath):
            try:
                safeDelete(archiveFolder)
                os.mkdir(archiveFolder)
                shutil.move(filepath, archiveFolder)
            except PermissionError:
                print("File unable to be moved, attemping to free...")
                freeFile(filepath)
                attempts += 1
        else:
            break
        
    # Archive File if successfull
    if os.path.isdir(filepath) or os.path.isfile(filepath):
        print(f"Failed to quaratine {filepath}")
    else:
        shutil.make_archive(filename, "zip", archiveFolder)
        addRecord(filename + ".zip", filepath)
    
    
    # Remove files
    safeDelete(archiveFolder)

def freeFile(filepath):
    for process in psutil.process_iter():
        try:
            # open_files seems to always raise an psutil.AccessDenied error
            # even when running in escalated privileges
            for file in process.open_files():
                if os.path.samefile(file.path, filepath):
                    print(f"Attempting to kill {process.name()}")
                    try:
                        process.kill()
                        print("Killed")
                    except:
                        print(f"Error killing process {process.name()}")
        except psutil.AccessDenied:
            pass

    print("File freed (probably)")
            

# Use this instead of shutil.rmtree (susceptible to symlink attack)
def safeDelete(filepath):
    failed = 0
    # Folder
    if os.path.isdir(filepath):
        files = os.listdir(filepath)
        # Delete files
        for file in files:
            if os.path.isfile(f"{filepath}\\{file}"):
                try:
                    os.remove(f"{filepath}\\{file}")
                except:
                    failed += 1
        # Delete folders
        for file in files:
            if os.path.isdir(f"{filepath}\\{file}"):
                safeDelete(f"{filepath}\\{file}")
        # Delete passed folder
        try:
            os.rmdir(filepath)
        except:
            failed += 1
    
    # File
    elif os.path.isfile(filepath):
        try:
            os.remove(file)
        except:
            failed += 1
    
    # Not Found
    else:
        print(f"{filepath} not found for deletion")
    
    if failed > 0:
        print(f"Failed to delete {failed} files/folders")
        
def loadRecord(recordPath="quarantined.json"):
    if not os.path.isfile(recordPath):
        with open(recordPath, "w", encoding="utf-8") as recordFile:
            recordFile.write("{}")
            
    with open(recordPath, "r", encoding="utf-8") as recordFile:
        record = json.load(recordFile)
    return record

def saveRecord(record, recordPath="quarantined.json"):
    with open(recordPath, "w", encoding="utf-8") as recordFile:
            recordFile.write(json.dumps(record, indent=2))
        
def addRecord(filepath, origpath):
    record = loadRecord()
    
    if not filepath in record:
        record[os.path.abspath(filepath)] = origpath
        saveRecord(record)
    else:
        # Gotta add error log later
        print("Couldn't add quarantine record for: " + filepath)
            
def removeRecord(filepath, recordPath="quarantined.json"):
    record = loadRecord(recordPath)
            
    if filepath in record:
        del record[filepath]
        saveRecord(record)

# Restore a quarantined file
# filepath is path of the quarantined .zip file
# Returns True on success and False on fail
def restore(filepath, recordPath="quarantined.json"):
    record = loadRecord(recordPath)
    filepath = os.path.normpath(filepath)
    
    try:
        dest = os.path.dirname(record[filepath])
        os.makedirs(dest, exist_ok=True)
        shutil.unpack_archive(filepath, dest)
        os.remove(filepath)
        removeRecord(filepath, recordPath)
    except:
        return False
    
    return True
        
def main():
    file = input("Enter path of file/folder to quarantine: ")
    if os.path.isfile(file) or os.path.isdir(file):
        try:
            quarantine(file)
        except:
            traceback.print_exc()
    else:
        print("Invalid file!")
        
    file = input("Enter path of file/folder to restore: ")
    if os.path.isfile(file) or os.path.isdir(file):
        try:
            restore(file)
        except:
            traceback.print_exc()
    else:
        print("Invalid file!")
        
if __name__ == "__main__":
    if not pyuac.isUserAdmin():
        pyuac.runAsAdmin()
    else:
        main()
        input("Press enter to exit...")
