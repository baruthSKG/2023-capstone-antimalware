import sys
if __name__ == "__main__":
    sys.path.insert(1, '../')
    from ADD_SYS_PATHS import addSysPaths
    addSysPaths()
import os
import shutil
import psutil
import traceback
from datetime import datetime
import json
from time import gmtime, strftime
from logFunctions import errorLog
import py7zr

# Archives file/folder at filepath, then removes original file if successful
def quarantine(filepath, recordPath="../quarantine/quarantined.json", storageFolder="../quarantine/archivedFiles", textbox=None):
    if filepath == "":
        return False
    filepath = os.path.abspath(filepath)
    if textbox != None:
            textbox.insert("end", f"Quarantining {filepath}\n")
        
    # Make folder for storing archived files
    if not os.path.isdir(storageFolder):
        os.mkdir(storageFolder)
    
    # Make archive file name
    filename = storageFolder + "\\" + datetime.now().strftime("%m-%d-%Y %H-%M-%S") + ".7z"
    count = 1
    origFilename = filename
    while os.path.isfile(filename) or os.path.isfile(filename):
        filename = f"{origFilename} ({count})"
        count += 1
    
    # Archive File
    with py7zr.SevenZipFile(filename, mode='w', password="infected") as archive:
        head, tail = os.path.split(filepath)
        if tail != "":
            archiveName = tail
        else:
            archiveName = os.path.split(head)[1]
        archive.writeall(filepath, arcname=archiveName)
    
    if not os.path.isfile(filename):
        # Report error
        timestamp  = strftime("%m-%d-%Y %H %M %S", gmtime())
        errorLog(timestamp, filepath, "Failed to quarantine - couldn't create archive")
        if textbox != None:
            textbox.insert("end", f"Failed to quaratine {filepath} - couldn't create archive\n")
        print(f"Failed to quarantine {filepath} - couldn't create archive")
        
        return False # Failed - don't delete file
    
    addRecord(filename, filepath, recordPath)
        
    # Delete file
    attempts = 0
    max = 3
    while attempts < max:
        if os.path.isdir(filepath) or os.path.isfile(filepath):
            try:
                safeDelete(filepath)
            except PermissionError:
                pass
            if os.path.isdir(filepath) or os.path.isfile(filepath):
                print("File unable to be deleted, attemping to free...")
                freeFile(filepath)
            attempts += 1
        else:
            break
        
    # Check for successful deletion
    if os.path.isdir(filepath) or os.path.isfile(filepath):
        timestamp  = strftime("%m-%d-%Y %H %M %S", gmtime())
        errorLog(timestamp, filepath, "Failed to quarantine - couldn't delete file")
        if textbox != None:
            textbox.insert("end", f"Failed to quaratine {filepath} - couldn't delete file\n")
        print(f"Failed to quarantine {filepath} - couldn't delete file")
        
        return False # Failed - archive isn't deleted in case of partial deletion of file
    else:
        return True


def freeFile(filepath):
    for process in psutil.process_iter():
        try:
            # open_files seems to always raise an psutil.AccessDenied error
            # even when running in escalated privileges
            for file in process.open_files():
                if os.path.samefile(file.path, filepath):
                    print(f"Attempting to kill {process.name()}")
                    try:
                        process.kill()
                        print("Killed")
                    except:
                        print(f"Error killing process {process.name()}")
        except psutil.AccessDenied:
            pass

    print("File freed (probably)")
            

# Use this instead of shutil.rmtree (susceptible to symlink attack)
def safeDelete(filepath):
    if os.path.isfile(filepath):
        try:
            os.remove(filepath)
            return True
        except:
            return False
    
    failed = 0
    for root, dirs, files in os.walk(filepath, topdown=False):
        for file in files:
            try:
                os.remove(root + "/" + file)
            except:
                failed += 1
        for dir in dirs:
            try:
                os.rmdir(root + "/" + dir)
            except:
                failed += 1
        try:
            os.rmdir(root)
        except:
            failed += 1
    return failed == 0

        
def loadRecord(recordPath="../quarantine/quarantined.json"):
    if not os.path.isfile(recordPath):
        with open(recordPath, "w", encoding="utf-8") as recordFile:
            recordFile.write("{}")
            
    with open(recordPath, "r", encoding="utf-8") as recordFile:
        record = json.load(recordFile)
    return record

def saveRecord(record, recordPath="../quarantine/quarantined.json"):
    with open(recordPath, "w", encoding="utf-8") as recordFile:
            recordFile.write(json.dumps(record, indent=2))
        
def addRecord(filepath, origpath, recordPath="../quarantine/quarantined.json"):
    record = loadRecord(recordPath)
    filepath = os.path.abspath(filepath)
    origpath = os.path.abspath(origpath)
    
    if not filepath in record:
        record[filepath] = origpath
        saveRecord(record, recordPath)
    else:
        # Gotta add error log later
        print("Couldn't add quarantine record for: " + filepath)
            
def removeRecord(filepath, recordPath="../quarantine/quarantined.json"):
    record = loadRecord(recordPath)
    filepath = os.path.abspath(filepath)
            
    if filepath in record:
        del record[filepath]
        saveRecord(record, recordPath)

# Restore a quarantined file
# filepath is path of the archive file
# Returns True on success and False on fail
def restore(filepath, recordPath="../quarantine/quarantined.json"):
    record = loadRecord(recordPath)
    filepath = os.path.abspath(filepath)
    
    try:
        dest = os.path.dirname(record[filepath])
        os.makedirs(dest, exist_ok=True)
        #shutil.unpack_archive(filepath, dest)
        with py7zr.SevenZipFile(filepath, 'r', password="infected") as archive:
            archive.extractall(path=dest)
        os.remove(filepath)
        removeRecord(filepath, recordPath)
    except:
        return False
    
    return True
        
        
if __name__ == "__main__":
    from infectionsGUI import infectionsGUI
    infectionsGUI()
